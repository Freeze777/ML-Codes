(function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;jQuery(function(){var ChallengeCommentsView,HR,ref;return ChallengeCommentsView=function(superClass){function ChallengeCommentsView(){return ChallengeCommentsView.__super__.constructor.apply(this,arguments)}return extend(ChallengeCommentsView,superClass),ChallengeCommentsView.prototype.template="forum/challenge-comments",ChallengeCommentsView.prototype.className="challenge-comments-view container",ChallengeCommentsView.prototype.eager_load_asset_list=["compound/challenge-views","compound/submission-views"],ChallengeCommentsView.prototype.initialize=function(options){return this.challenge=options.challenge,this.profile=options.profile,this.contest=options.contest,this.listenTo(this.challenge,"reset",this.render),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.profile,"reset",this.render),this.current_sort_type=options.sort_type||"Votes",this.contest.get("hidden")===!0&&(this.current_sort_type="Recent"),this.expert_tab_embed=options.expert_tab_embed||!1,this.contest.get("comment_live_sync")===!0?this.setupPusher():void 0},ChallengeCommentsView.prototype.events={"click div.more-comment-list":"getMore"},ChallengeCommentsView.prototype.handleScroll=function(){var pos,that;return pos=$(window).scrollTop()+$(window).height(),that=this,pos>=$(document).height()-100?that.getMore():void 0},ChallengeCommentsView.prototype.render=function(){return this.challenge.sync_status&&this.collection.sync_status?($(this.el).html(HR.appController.template(this.template,this)({collection:this.collection})),this.$("div.comment-header-view").length>0&&(this.comment_header_view||(this.comment_header_view=new HR.CommentsHeaderView({challenge:this.challenge,collection:this.collection,profile:this.profile,contest:this.contest,expert_tab_embed:this.expert_tab_embed,parent:this})),this.assign({"div.comment-header-view":this.comment_header_view}),this.add_subview(this.comment_header_view)),this.$("div.comments-container").length>0&&(this.comment_lists_view||(this.comment_lists_view=new HR.CommentListView({challenge:this.challenge,collection:this.collection,profile:this.profile,expert_tab_embed:this.expert_tab_embed})),this.assign({"div.comments-container":this.comment_lists_view}),this.add_subview(this.comment_lists_view)),this):($(this.el).html(HR.appController.viewLoader(64)),this)},ChallengeCommentsView.prototype.getMore=function(e){var that;return e&&e.preventDefault(),this.collection.total<=this.collection.length||this.loadingComments?void 0:(this.loadingComments=!0,$(this.el).append(HR.appController.viewLoader(64)),this.collection.page+=1,that=this,this.collection.fetch({remove:!1,silent:!0,success:function(){return that.render(),that.loadingComments=!1},error:function(){return this.$("more-comment-list").removeClass("hide")}}))},ChallengeCommentsView.prototype.setupPusher=function(){var channel,pusher,that;return pusher=new Pusher(window.pusher_app_key),channel=pusher.subscribe("comments-con-"+this.contest.get("id")+"-ch-"+this.challenge.get("id")),that=this,pusher.connection.bind("connected",function(){return function(){return HR.pusher_socket_id=pusher.connection.socket_id}}(this)),channel.bind("update_comment",function(data){return that.updateComment(data.model.ancestry,data.model.id,data.model.description_html,data.model.deleted)}),channel.bind("create_comment",function(data){return that.addComment(data)}),channel.bind("delete_comment",function(data){return that.updateComment(data.model.ancestry,data.model.id,data.model.description_html,data.model.deleted)})},ChallengeCommentsView.prototype.addComment=function(data){var _model,_new_model,children,comment_chain,loc;if(data.model.ancestry){if(comment_chain=data.model.ancestry.split("/").map(function(ele){return parseInt(ele)}),comment_chain.length>0&&(_model=this.collection.get(comment_chain[0]),typeof _model==typeof{}))if(children=_model.get("children"),1===comment_chain.length){if(loc=this.hasModel(children,data.model.id),-1===loc)return children.push(data.model),this.render()}else if(loc=this.hasModel(children,comment_chain[1]),-1!==loc)return this.recursiveModelAdd(comment_chain.slice(2,comment_chain.length),data.model,children[loc])}else if(typeof this.collection.get(data.model.id)!=typeof{})return _new_model=new HR.CommentModel,_new_model.set(data.model),this.collection.add(_new_model,{at:0})},ChallengeCommentsView.prototype.updateComment=function(ancestry,id,description_html,deleted){var _model,children,comment_chain,loc;if(null==deleted&&(deleted=!1),ancestry){if(comment_chain=ancestry.split("/").map(function(ele){return parseInt(ele)}),comment_chain.length>0&&(_model=this.collection.get(comment_chain[0]),typeof _model==typeof{}))if(children=_model.get("children"),1===comment_chain.length){if(loc=this.hasModel(children,id),-1!==loc)return children[loc].description_html=description_html,children[loc].deleted=deleted,this.render()}else if(loc=this.hasModel(children,comment_chain[1]),-1!==loc)return this.recursiveModelUpdate(comment_chain.slice(2,comment_chain.length),id,description_html,deleted,children[loc])}else{if(deleted)return this.collection.remove(id),this.render();if(_model=this.collection.get(id),typeof _model==typeof{})return _model.set("description_html",description_html),this.render()}},ChallengeCommentsView.prototype.hasModel=function(children,id){var children_ids;return children_ids=children.map(function(ele){return parseInt(ele.id)}),$.inArray(id,children_ids)},ChallengeCommentsView.prototype.recursiveModelAdd=function(comment_chain,new_model,model){var loc;return comment_chain.length<1?(loc=this.hasModel(model.children,new_model.id),-1===loc&&(model.children.push(new_model),this.render()),void 0):(loc=this.hasModel(model.children,comment_chain[0]),-1!==loc?this.recursiveModelAdd(comment_chain.slice(1,comment_chain.length),new_model,model.children[loc]):void 0)},ChallengeCommentsView.prototype.recursiveModelUpdate=function(comment_chain,id,description_html,deleted,model){var loc;return comment_chain.length<1?(loc=this.hasModel(model.children,id),-1!==loc&&(model.description_html=description_html,model.deleted=deleted,this.render()),void 0):(loc=this.hasModel(model.children,comment_chain[0]),-1!==loc?this.recursiveModelUpdate(comment_chain.slice(1,comment_chain.length),id,description_html,deleted,model.children[loc]):void 0)},ChallengeCommentsView}(window.HR.GenericView),HR=null!=(ref=window.HR)?ref:{},HR.ChallengeCommentsView=ChallengeCommentsView})}).call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;jQuery(function(){var ChallengeQuestionsSidebarHeaderView,HR,ref;return ChallengeQuestionsSidebarHeaderView=function(superClass){function ChallengeQuestionsSidebarHeaderView(){return ChallengeQuestionsSidebarHeaderView.__super__.constructor.apply(this,arguments)}return extend(ChallengeQuestionsSidebarHeaderView,superClass),ChallengeQuestionsSidebarHeaderView.prototype.template="forum/challenge-questions-sidebar-header",ChallengeQuestionsSidebarHeaderView.prototype.className="challenge-questions-sidebar-header-view",ChallengeQuestionsSidebarHeaderView.prototype.initialize=function(options){return this.challenge=options.challenge,this.listenTo(HR.profile(),"reset",this.render),this.render()},ChallengeQuestionsSidebarHeaderView.prototype.render=function(){return $(this.el).html(HR.appController.template(this.template,this)({challenge:this.challenge,profile:HR.profile()})),this},ChallengeQuestionsSidebarHeaderView}(window.HR.GenericView),HR=null!=(ref=window.HR)?ref:{},HR.ChallengeQuestionsSidebarHeaderView=ChallengeQuestionsSidebarHeaderView})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;jQuery(function(){var ChallengeQuestionsSidebarView,HR,ref;return ChallengeQuestionsSidebarView=function(superClass){function ChallengeQuestionsSidebarView(){return ChallengeQuestionsSidebarView.__super__.constructor.apply(this,arguments)}return extend(ChallengeQuestionsSidebarView,superClass),ChallengeQuestionsSidebarView.prototype.template="forum/challenge-questions-sidebar",ChallengeQuestionsSidebarView.prototype.className="challenge-questions-sidebar-view",ChallengeQuestionsSidebarView.prototype.initialize=function(options){return this.challenge=options.challenge,this.render()},ChallengeQuestionsSidebarView.prototype.render=function(){var that;return $(this.el).html(HR.appController.template(this.template,this)()),that=this,this.$(".header").length>0&&(this.header=new HR.ChallengeQuestionsSidebarHeaderView({el:this.$(".header"),challenge:this.challenge})),this},ChallengeQuestionsSidebarView}(window.HR.GenericView),HR=null!=(ref=window.HR)?ref:{},HR.ChallengeQuestionsSidebarView=ChallengeQuestionsSidebarView})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;jQuery(function(){var CommentListView,HR,ref;return CommentListView=function(superClass){function CommentListView(){return CommentListView.__super__.constructor.apply(this,arguments)}return extend(CommentListView,superClass),CommentListView.prototype.template="forum/comment-list",CommentListView.prototype.className="comment-list-view",CommentListView.prototype.initialize=function(options){return this.parent=options.parent,this.profile=options.profile,this.challenge=options.challenge,this.collection=options.collection,this.listenTo(this.collection,"add",this.render),this.comment_box_content={}},CommentListView.prototype.render=function(){var comment_stubs,i,len,ref,subView,that;if(null!=this._subviews)for(ref=this._subviews,i=0,len=ref.length;len>i;i++)subView=ref[i],subView.destroy(),subView=null;return $(this.el).html(HR.appController.template(this.template,this)()),comment_stubs=$(),that=this,this.collection.sync_status?(this.$(".discussion-comments").html(""),_.each(this.collection.models,function(model){var _view;return model.set("challenge_slug",that.challenge.get("slug")),_view=new HR.CommentView({challenge_slug:that.challenge.get("slug"),challenge:that.challenge,model:model,collection:that.collection,profile:that.profile,root_comment:model,parent:that,comment_box_content:that.comment_box_content}),that.add_subview(_view),comment_stubs.push(_view.render().el)}),this.$(".discussion-comments").append(comment_stubs)):$(this.el).html(HR.appController.viewLoader(64)),this.delegateEvents(),this},CommentListView.prototype.subscription=function(event){return event.preventDefault()},CommentListView.prototype.addComment=function(comment){return this.collection.push(comment)},CommentListView}(window.HR.GenericView),HR=null!=(ref=window.HR)?ref:{},HR.CommentListView=CommentListView})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;jQuery(function(){var CommentView,HR,ref;return CommentView=function(superClass){function CommentView(){return CommentView.__super__.constructor.apply(this,arguments)}return extend(CommentView,superClass),CommentView.prototype.template="forum/comment",CommentView.prototype.className="single-comment",CommentView.prototype.initialize=function(options){return this.parent=options.parent,this.collection=options.collection,this.profile=options.profile,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"reset",this.render),this.challenge_slug=options.challenge_slug,this.challenge=options.challenge,this.single_comment=options.single_comment,this.root_comment=options.root_comment,this.child_id=options.child_id,this.comment_box_content=options.comment_box_content||{},this.listenTo(this.profile,"reset",this.render)},CommentView.prototype.render=function(){var box_content,scrollToElement,that;return this.single_comment&&!this.model.sync_status?($(this.el).append(HR.appController.viewLoader(64)),this):this.model.get("deleted")===!0&&0===_.size(this.model.get("children"))?this.destroy():(this.single_comment&&this.model.get("is_only_comment")&&HR.router.navigate(HR.appController.get_challenge_pageURL(this.model.contest_slug,this.challenge_slug)+"/forum",{trigger:!0,replace:!0}),$(this.el).html(HR.appController.template(this.template,this)({comment:this.model.toJSON(),_model:this.model,single_comment:this.single_comment,challenge_slug:this.challenge_slug,profile:this.profile,canEditDelete:this.canEditDelete(),challenge_page_url:this.challengePageURL(),view:this})),this.$(".timeago").timeago(),this.render_children(),that=this,scrollToElement=function(){var element;return element=$("li[data-id="+that.child_id+"]"),element.length>0?($("html body").animate({scrollTop:element.offset().top},1e3),$("li[data-id="+that.child_id+"]").effect("highlight",{},3500),that.child_id=null):void 0},this.child_id&&setTimeout(function(){return scrollToElement.call(that)},300),box_content=this.comment_box_content[this.model.get("id")],null!=box_content&&null!=box_content.text&&this.showResponseCommentBox(),this)},CommentView.prototype.destroy=function(){return this.removed!==!0?CommentView.__super__.destroy.call(this):void 0},CommentView.prototype.destroyChildren=function(){return this._subviews&&_.isArray(this._subviews)?_.each(this._subviews,function(subview){return subview&&subview.destroy?subview.destroy():void 0}):void 0},CommentView.prototype.render_children=function(){var $ul,that;return this.model.get("children").length>0?(this.destroyChildren(),this._subviews=[],$ul=$(),this.$("ul.children-comments").html(""),that=this,_.each(this.model.get("children"),function(_model){var _view,model,view_html;return model=new HR.CommentModel,model.set(_model),model.collection=that.collection,model.set("challenge_slug",that.challenge_slug),_view=new HR.CommentView({model:model,challenge_slug:that.challenge_slug,collection:that.collection,challenge:that.challenge,profile:that.profile,root_comment:that.root_comment,parent:that,comment_box_content:that.comment_box_content}),view_html=_view.render().el,that.add_subview(_view),view_html?$ul.push(view_html):void 0}),this.$("ul.children-comments").append($ul)):void 0},CommentView.prototype.events={"click a.discussion-upvote":"upvoteComment","click a.discussion-downvote":"downvoteComment","click i.minimize-comment":"minimizeComment","click i.maximize-comment":"maximizeComment","click a.show-response":"showResponse","click a.cancel-response":"cancelResponse","click a.cancel-update-comment":"cancelUpdateComment","click a.add-reply":"addReply","click a.update-reply":"updateReply","click a.edit-comment":"editComment","click a.delete-comment":"deleteComment","click .appreciate-answer-add":"appreciateAnswer","click .mark-spam":"markSpam","click .unmark-spam":"unmarkSpam"},CommentView.prototype.deleteComment=function(event){var that;return event.stopPropagation(),event.preventDefault(),$(this.el).find(".comment-section[data-id="+this.model.get("id")+"]").html(HR.appController.viewLoader(32)),that=this,this.model.destroy({success:function(_this){return function(model,response){var children;return _this.model.set(response.model),_this.render(),children=that.parent.model.get("children"),0===_.size(that.model.get("children"))&&(children=_.reject(children,function(m){return m.id===that.model.get("id")})),that.parent.model.set("children",children)}}(this)}),hr_metrics.track("Click","ForumCommentDelete",this.commonTrackAttrs())},CommentView.prototype.appreciateAnswer=function(){return this.model.appreciate(!0),this.$(".appreciate-container").removeClass("appreciate-answer-add"),this.$(".appreciate-container").addClass("appreciate-answer-remove"),this.$(".appreciate-container").html("<i class='icon-star'></i> <strong> Endorsed by you</strong>"),this.$(".forum-gold-star-user").addClass("state-disabled").removeClass("state-enabled")},CommentView.prototype.removeAppreciation=function(){return this.model.appreciate(!1),this.$(".appreciate-container").addClass("appreciate-answer-remove"),this.$(".appreciate-container").removeClass("appreciate-answer-add"),this.$(".appreciate-container").html("<i class='icon-star-empty'></i> <strong> Endorse this comment</strong></span>"),this.$(".forum-gold-star-user").addClass("state-enabled").removeClass("state-disabled")},CommentView.prototype.markSpam=function(e){var elem;return elem=$(e.currentTarget).parent(),this.model.markSpam(function(){return elem.find(".mark-spam").hide(),elem.find(".unmark-spam").show()})},CommentView.prototype.unmarkSpam=function(e){var elem;return elem=$(e.currentTarget).parent(),this.model.unmarkSpam(function(){return elem.find(".unmark-spam").hide(),elem.find(".mark-spam").show()})},CommentView.prototype.updateReply=function(event){var $el,button,description_text,errorDiv,existingText,parent_id,that;if(event.stopPropagation(),event.preventDefault(),button=$(event.currentTarget),$el=this.getCommentElement(),existingText=button.html(),description_text=this.comment_editor.getValue(),description_text.length<3)return $el.find("#comment-error").html("Comment should contain at least 3 characters."),$el.find("#comment-error").fadeIn(),button.removeClass("disabled"),setTimeout(function(){return function(){return $el.find("#comment-error").fadeOut()}}(this),2e3),void 0;if(button.html("Updating..."),parent_id=$el.data("id"),errorDiv=this.$("#comment-error"),!button.hasClass("disabled")){if(button.addClass("disabled"),that=this,this.model.get("description")===description_text)return this.cancelUpdateComment(event),void 0;this.model.set("description",description_text),this.model.save({},{error:function(){return $el.find("#comment-error").fadeIn(),button.removeClass("disabled"),button.html(existingText),setTimeout(function(){return function(){return $el.find("#comment-error").fadeOut()}}(this),3e3)}})}return hr_metrics.track("Click","ForumUpdateReply",this.commonTrackAttrs())},CommentView.prototype.cancelUpdateComment=function(event){var $comment;return event.stopPropagation(),event.preventDefault(),$comment=$(this.el).find(".comment-content").first(),$comment.html(this.model.get("description_html")),hr_metrics.track("Click","ForumUpdateReplyCancel",this.commonTrackAttrs())},CommentView.prototype.editComment=function(event){var $codeeditor,$comment,editorOptions,html,that;return event.stopPropagation(),event.preventDefault(),html=this.$("#comment-edit").html(),$comment=$(this.el).find(".comment-content").first(),$comment.html(html),that=this,editorOptions={lineNumbers:!1,lineWrapping:!0,matchBrackets:!0,mode:"text/x-markdown",indentUnit:4},$codeeditor=$(this.el).find(".comment-edit-description").get(0),$codeeditor&&HR.appController.loadCodeMirrorMode("markdown",function(_this){return function(){return _this.comment_editor=CodeMirror.fromTextArea($codeeditor,editorOptions),_this.comment_editor.setValue(_this.model.get("description")),_this.comment_editor.focus(),_this.comment_editor.on("change",function(){return that.updatePreview(that.comment_editor,"comment-edit"),this})}}(this)),hr_metrics.track("Click","ForumCommentEdit",this.commonTrackAttrs())},CommentView.prototype.addReply=function(event){var $el,button,comment,description_text,errorDiv,existingText,parent_id,that;return event.stopPropagation(),event.preventDefault(),button=$(event.currentTarget),$el=this.getCommentElement(),existingText=button.html(),description_text=this.editor.getValue(),description_text.length<3?($el.find("#comment-error").html("Comment should contain at least 3 characters."),$el.find("#comment-error").fadeIn(),button.removeClass("disabled"),setTimeout(function(){return function(){return $el.find("#comment-error").fadeOut()}}(this),2e3),void 0):(button.html("Posting..."),parent_id=$el.data("id"),errorDiv=this.$("#comment-error"),that=this,button.hasClass("disabled")||(button.addClass("disabled"),that=this,comment=new HR.CommentModel,comment.set({challenge_slug:this.challenge_slug,description:description_text,children:[],parent_id:parent_id}),comment.save({},{success:function(model,response){var _view,children,view_html;return response.status===!0?(null!=that.comment_box_content&&null!=that.model.get("id")&&(that.comment_box_content[that.model.get("id")]=null),2===model.get("kind")&&that.updateExpertResponseCount(model.get("hacker_id")),button.removeClass("disabled"),button.html(existingText),_view=new HR.CommentView({model:model,challenge_slug:that.challenge_slug,profile:that.profile,collection:that.collection,root_comment:that.root_comment,challenge:that.challenge,parent:that,comment_box_content:that.comment_box_content}),view_html=_view.render().el,$($el.find("ul.children-comments").get(0)).append(view_html),that.cancelResponse(event),children=that.model.get("children"),children.push(model.toJSON()),that.model.set("children",children)):($el.find("#comment-error").html(response.message).fadeIn(),button.removeClass("disabled"),button.html(existingText),setTimeout(function(){return function(){return $el.find("#comment-error").fadeOut()}}(this),3e3))},error:function(){return $el.find("#comment-error").fadeIn(),button.removeClass("disabled"),button.html(existingText),setTimeout(function(){return function(){return $el.find("#comment-error").fadeOut()}}(this),3e3)}})),hr_metrics.track("Click","ForumAddReply",$.extend(this.commonTrackAttrs(),{attribute3:"Editor"})))},CommentView.prototype.updateExpertResponseCount=function(hacker_id){var answered_count,comment_id,experts,img,text;return experts=this.model.get("experts"),comment_id=this.model.get("id"),_.each(experts,function(expert){return expert.hacker.id===hacker_id?expert.status=2:void 0}),answered_count=_.filter(experts,function(expert){return 2===expert.status}).length,text=answered_count>0?"Answered by "+answered_count+" of "+experts.length+" experts":"Waiting for reply from experts",this.$(".discussion-expert-text[data-comment-id="+comment_id+"]").html(text),img=this.$(".discussion-expert-images[data-comment-id="+comment_id+"] .discussion-expert-image[data-expert-id="+hacker_id+"]"),$(img).hasClass("discussion-expert-answered")?void 0:$(img).addClass("discussion-expert-answered")},CommentView.prototype.getCommentElement=function(){return $(this.el).find("li.discussion-comment").first()},CommentView.prototype.showResponse=function(event){return event&&event.stopPropagation(),event&&event.preventDefault(),this.showResponseCommentBox(),hr_metrics.track("Click","ForumAddReply",$.extend(this.commonTrackAttrs(),{attribute3:"Comment"}))},CommentView.prototype.showResponseCommentBox=function(){var $codeeditor,$el,editorOptions,that;return $el=$(this.el).find(".comment-response").first(),$el.removeClass("hide"),!this.editor&&(that=this,editorOptions={lineNumbers:!1,lineWrapping:!0,matchBrackets:!0,mode:"text/x-markdown",indentUnit:4},$codeeditor=$el.find(".comment-description").get(0))?HR.appController.loadCodeMirrorMode("markdown",function(_this){return function(){var box_content;return _this.editor=CodeMirror.fromTextArea($codeeditor,editorOptions),_this.editor.focus(),_this.editor.on("change",function(){return that.updatePreview(that.editor),this._presetting_value||(that.comment_box_content[that.model.get("id")]={text:that.editor.getValue(),cursorPos:that.editor.getCursor()}),this}),box_content=_this.comment_box_content[_this.model.get("id")],null!=box_content&&null!=box_content.text?(_this.editor.focus(),_this._presetting_value=!0,_this.editor.setValue(box_content.text),_this.editor.setCursor(box_content.cursorPos||0),_this._presetting_value=!1):void 0}}(this)):void 0},CommentView.prototype.updatePreview=function(editor,parentClass){return null==parentClass&&(parentClass="comment-response"),HR.requires(["sanitize"],function(_this){return function(){var $el,sanitized_text;return sanitized_text=HackDown.processData(editor.getValue()),$el=$(_this.el).find("."+parentClass).first(),""===sanitized_text?$el.find(".preview-wrap").hide():$el.find(".preview-wrap").show(),$el.find("#comment-preview").html(sanitized_text)}}(this))},CommentView.prototype.cancelResponse=function(event){return event.stopPropagation(),event.preventDefault(),$(this.el).find(".comment-response").first().addClass("hide"),null!=this.comment_box_content&&null!=this.model.get("id")&&(this.comment_box_content[this.model.get("id")]=null),hr_metrics.track("Click","ForumAddReplyCancel",this.commonTrackAttrs())},CommentView.prototype.minimizeComment=function(event){return event.stopPropagation(),event.preventDefault(),$(this.el).find("li.discussion-comment").first().addClass("is-collapsed"),$(this.el).find("ul.children-comments").addClass("hide"),hr_metrics.track("Click","ForumCommentMinimize",this.commonTrackAttrs())},CommentView.prototype.maximizeComment=function(event){return event.stopPropagation(),event.preventDefault(),$(this.el).find("li.discussion-comment").first().removeClass("is-collapsed"),$(this.el).find("ul.children-comments").removeClass("hide"),hr_metrics.track("Click","ForumCommentMaximize",this.commonTrackAttrs())},CommentView.prototype.upvoteComment=function(event){return this.voteComment(event,"upvote")},CommentView.prototype.downvoteComment=function(event){return this.voteComment(event,"downvote")},CommentView.prototype.voteComment=function(event,vote_type){var that,url,voteBtn,vote_status_mapping;return null==vote_type&&(vote_type="upvote"),event.preventDefault(),event.stopPropagation(),vote_status_mapping={unvote:0,upvote:1,downvote:2},voteBtn=$(event.currentTarget),this.canVote(this.model)&&!voteBtn.attr("disabled")?this.model.get("vote_status")===vote_status_mapping[vote_type]?(this.voteComment(event,"unvote"),void 0):(voteBtn.attr("disabled",!0),that=this,url="/rest/contests/"+HR.appController.get_current_contest_slug()+"/challenges/"+this.challenge_slug+"/comments/"+this.model.get("id")+"/"+vote_type,$.ajax({type:"PUT",url:url,success:function(resp){return resp.status?that.model.fetch():alert("You can't "+vote_type+" twice.")},error:function(){return voteBtn.removeAttr("disabled")}}),hr_metrics.track("Click","ForumCommentVote",$.extend(this.commonTrackAttrs(),{attribute3:vote_type}))):void 0},CommentView.prototype.ShowLoginDialog=function(){var dialog;return dialog=HR.util.ShowLoginDialog({error_message:"Please sign up or log in to upvote/downvote a comment",show_sign_up_link:!0}),dialog.render()},CommentView.prototype.canVote=function(comment){var dialog;return this.profile.isLoggedIn()?comment.get("hacker_id")===this.profile.get("id")?(dialog=HR.util.ShowConfirmationDialog({title:"Can't vote",body:"You can't vote your own comment.",buttons:[{name:"Ok",callback:function(dialog){return dialog.destroy()}}]}),dialog.render(),!1):!0:(this.ShowLoginDialog(),!1)},CommentView.prototype.canEditDelete=function(){return this.profile.isLoggedIn()&&(this.profile.get("id")===this.model.get("hacker_id")||this.profile.get("is_admin"))},CommentView.prototype.commonTrackAttrs=function(){return{attribute1:this.challenge_slug,attribute2:this.model.get("hacker_username"),attribute7:this.model.get("votes"),attribute11:this.model.get("hacker_is_admin")}},CommentView.prototype.challengePageURL=function(){return this.challenge?this.challenge.pageURL():HR.appController.get_current_contest_namespace()+"/challenges/"+this.challenge_slug},CommentView}(window.HR.GenericView),HR=null!=(ref=window.HR)?ref:{},HR.CommentView=CommentView})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;jQuery(function(){var CommentsHeaderView,HR,ref;return CommentsHeaderView=function(superClass){function CommentsHeaderView(){return CommentsHeaderView.__super__.constructor.apply(this,arguments)}return extend(CommentsHeaderView,superClass),CommentsHeaderView.prototype.template="forum/comments-header",CommentsHeaderView.prototype.className="comment-list-view",CommentsHeaderView.prototype.initialize=function(options){var that;return this.challenge=options.challenge,this.collection=options.collection,this.contest=options.contest,this.listenTo(this.collection,"add",this.render),this.parent=options.parent,this.expert_tab_embed=options.expert_tab_embed,this.delegateEvents(),that=this,this.experts=HR.appController.getCollection("challenge-experts",null,function(collection){return collection.contest_slug=that.contest.get("slug"),collection.challenge_slug=that.challenge.get("slug")}),this.listenTo(this.experts,"reset",this.render)},CommentsHeaderView.prototype.events={"click a.add-comment":"addComment","click a.login-link":"loginDialog","click a.comment-sort-option":"sortComments","change #expert-checkbox-box":"toggleExpertSelectionOption","mouseenter .experts-list":"trackHoverMetric","click .experts-list":"toggleExpertSelection","mouseout .experts-list":"focusOutSelection"},CommentsHeaderView.prototype.sortComments=function(e){var $el,sort_by;return e.preventDefault(),$el=$(e.currentTarget),sort_by=$el.data("sort-type"),this.$("span#comment-current-sort").html($el.html()),this.collection.setSortBy(sort_by),$(".comments-container").html(HR.appController.viewLoader(64)),$(".discussion-newcomment").addClass("hide"),this.collection.page=1,this.parent.current_sort_type=$el.html(),this.collection.flush(),this.collection.fetch({reset:!0}),hr_metrics.track("ChangeForumFilter",$el.html(),{attribute1:this.challenge.get("slug")})},CommentsHeaderView.prototype.render=function(){var $codeeditor,editorOptions,expert,expertsJson,i,index,len,that,usernameOfAsker;for(expertsJson=this.experts.toJSON(),$(this.el).html(HR.appController.template(this.template,this)({collection:this.collection,current_sort_type:this.parent.current_sort_type,challenge_slug:this.challenge.get("slug"),placeholder_text:this.placeholder_text,experts:expertsJson,expert_tab_embed:this.expert_tab_embed})),that=this,editorOptions={lineNumbers:!1,lineWrapping:!0,matchBrackets:!0,mode:"text/x-markdown",indentUnit:4,placeholder:this.placeholder_text},$codeeditor=this.$("#comment-description").get(0),$codeeditor&&HR.appController.loadCodeMirrorMode("markdown",function(_this){return function(){return _this.editor=CodeMirror.fromTextArea($codeeditor,editorOptions),_this.editor.on("change",function(){return that.updatePreview(),that.pastVal=that.editor.getValue(),that._presetting_value||(that.cursorPos=that.editor.getCursor()),this}),_this.editor.on("focus",function(){return that.onFocus()}),null!=_this.pastVal?(_this.editor.focus(),_this._presetting_value=!0,_this.editor.setValue(_this.pastVal),_this.editor.setCursor(_this.cursorPos||0),_this._presetting_value=!1):void 0}}(this)),usernameOfAsker=HR.profile().get("username"),index=i=0,len=expertsJson.length;len>i;index=++i)expert=expertsJson[index],hr_metrics.batch_track("expertListed",expert.username,{attribute1:expert.why,attribute2:usernameOfAsker,attribute7:index,attribute8:this.challenge.get("id"),attribute9:this.contest.get("id")});return this},CommentsHeaderView.prototype.onFocus=function(){var that;return this.$(".js-error-msg-wrap").hide().html(""),that=this,this.$(".comment-editor").removeClass("comment-editor-not-focused"),_.each([".expert-checkbox",".markdown-hint",".post-button-wrap"],function(el){return that.$(el).show()}),this.$("#expert-checkbox-box").hasClass("js-done-first-time")?void 0:(this.$("#expert-checkbox-box").addClass("js-done-first-time"),this.$("#expert-checkbox-box").prop("checked",!0),this.$(".experts-wrap").fadeIn(),this.$(".challenge-experts").addClass("give-hover-animation"))},CommentsHeaderView.prototype.updatePreview=function(){return HR.requires(["sanitize"],function(_this){return function(){var sanitized_text;return sanitized_text=HackDown.processData(_this.editor.getValue()),""===sanitized_text?_this.$(".preview-wrap").hide():_this.$(".preview-wrap").show(),_this.$("#comment-preview").html(sanitized_text)
}}(this))},CommentsHeaderView.prototype.addComment=function(event){var button,comment,description_text,err,error,errorDiv,existingText,expert_ids,expert_set,messageDialog,that;if(event.preventDefault(),button=$(event.currentTarget),existingText=button.html(),description_text=this.editor.getValue(),description_text.length<3)return this.$("#comment-error").html("Comment should contain at least 3 characters."),this.$("#comment-error").fadeIn(),button.removeClass("disabled"),setTimeout(function(){return function(){return $("#comment-error").fadeOut()}}(this),2e3),void 0;if(button.html("Posting..."),errorDiv=this.$("#comment-error"),!button.hasClass("disabled")){button.addClass("disabled"),that=this,comment=new HR.CommentModel,comment.set({challenge_slug:this.challenge.get("slug"),description:description_text,children:[]});try{expert_set=this.$("#expert-checkbox-box")[0].checked}catch(error){err=error,expert_set=!1}if(expert_set){if(expert_ids=this.finalExpertsId(),0===expert_ids.length)return messageDialog=HR.util.ShowDialog({body:"Please choose experts from the right sidebar before posting.",title:"No Expert Selected",buttons:[{name:"OK","class":"btn-primary",callback:function(dialog){return dialog.destroy()}}]}),messageDialog.render(),button.removeClass("disabled"),button.html(existingText),void 0}else expert_ids=[];return comment.set({challenge_slug:this.challenge.get("slug"),description:description_text,children:[],expert_ids:expert_ids,expert_set:expert_set}),comment.save({},{success:function(model,response){return response.status?(that.collection.setTotal(that.collection.total+1),that.collection.unshift(comment),that.editor.setValue(""),button.removeClass("disabled"),button.html(existingText)):(this.$("#comment-error").html(response.message).fadeIn(),button.removeClass("disabled"),button.html(existingText),setTimeout(function(){return function(){return $("#comment-error").fadeOut()}}(this),3e3)),response.error?(this.$(".js-error-msg-wrap").show(),this.$(".js-error-msg-wrap .js-msg").html(response.error),this.$(".experts-wrap").hide()):void 0},error:function(){return this.$("#comment-error").fadeIn(),button.removeClass("disabled"),button.html(existingText),setTimeout(function(){return function(){return $("#comment-error").fadeOut()}}(this),3e3)}})}},CommentsHeaderView.prototype.max_select_count=3,CommentsHeaderView.prototype.total_expert_count=5,CommentsHeaderView.prototype.finalExpertsId=function(){var expert_ids;return expert_ids=this.$(".challenge-experts .selected").map(function(){return $(this).attr("data-expert-id")}).get()},CommentsHeaderView.prototype.updateExpertsCount=function(){var selected_count;return selected_count=this.$(".challenge-experts .selected").length,0===selected_count?this.$(".selected-count").hide():selected_count>0&&(this.$(".selected-count").html("("+selected_count+" / "+this.max_select_count+" selected)"),this.$(".selected-count").show()),this.finalExpertsId()},CommentsHeaderView.prototype.loginDialog=function(){var dialog;return dialog=HR.util.ShowLoginDialog({show_sign_up_link:!0,success_callback:this.getAbModel}),dialog.render()},CommentsHeaderView.prototype.toggleExpertSelection=function(e){var selected_count;if(this.$("#expert-checkbox-box").is(":checked")){if($(e.currentTarget).hasClass("selected"))$(e.currentTarget).removeClass("selected");else{if(selected_count=this.$(".challenge-experts .selected").length,selected_count>=this.max_select_count)return;$(e.currentTarget).addClass("selected"),$(e.currentTarget).addClass("just-now")}return this.updateExpertsCount()}},CommentsHeaderView.prototype.focusOutSelection=function(e){return $(e.relatedTarget).hasClass("tick")?void 0:$(e.currentTarget).hasClass("just-now")?$(e.currentTarget).removeClass("just-now"):void 0},CommentsHeaderView.prototype.toggleExpertSelectionOption=function(e){return $(e.currentTarget).is(":checked")?(this.$(".challenge-experts").hasClass("give-hover-animation")||this.$(".challenge-experts").addClass("give-hover-animation"),this.$(".experts-wrap").fadeIn()):(this.$(".challenge-experts .selected").each(function(){return $(this).removeClass("selected")}),this.$(".selected-count").html("").hide(),this.$(".challenge-experts").hasClass("give-hover-animation")&&this.$(".challenge-experts").removeClass("give-hover-animation"),this.$(".experts-wrap").fadeOut())},CommentsHeaderView.prototype.trackHoverMetric=function(e){return hr_metrics.track("hoverOnExpertInList",$(e.currentTarget).find(".expert-username a").html(),{attribute1:HR.profile().get("username"),attribute7:$(e.currentTarget).attr("data-expert-position"),attribute8:this.challenge.get("id"),attribute9:this.contest.get("id")})},CommentsHeaderView}(window.HR.GenericView),HR=null!=(ref=window.HR)?ref:{},HR.CommentsHeaderView=CommentsHeaderView})}.call(this),function(){function Pusher(app_key,options){checkAppKey(app_key),options=options||{};var self=this;this.key=app_key,this.config=Pusher.Util.extend(Pusher.getGlobalConfig(),options.cluster?Pusher.getClusterConfig(options.cluster):{},options),this.channels=new Pusher.Channels,this.global_emitter=new Pusher.EventsDispatcher,this.sessionID=Math.floor(1e9*Math.random()),this.timeline=new Pusher.Timeline(this.key,this.sessionID,{cluster:this.config.cluster,features:Pusher.Util.getClientFeatures(),params:this.config.timelineParams||{},limit:50,level:Pusher.Timeline.INFO,version:Pusher.VERSION}),this.config.disableStats||(this.timelineSender=new Pusher.TimelineSender(this.timeline,{host:this.config.statsHost,path:"/timeline/v2/jsonp"}));var getStrategy=function(options){var config=Pusher.Util.extend({},self.config,options);return Pusher.StrategyBuilder.build(Pusher.getDefaultStrategy(config),config)};this.connection=new Pusher.ConnectionManager(this.key,Pusher.Util.extend({getStrategy:getStrategy,timeline:this.timeline,activityTimeout:this.config.activity_timeout,pongTimeout:this.config.pong_timeout,unavailableTimeout:this.config.unavailable_timeout},this.config,{encrypted:this.isEncrypted()})),this.connection.bind("connected",function(){self.subscribeAll(),self.timelineSender&&self.timelineSender.send(self.connection.isEncrypted())}),this.connection.bind("message",function(params){var internal=0===params.event.indexOf("pusher_internal:");if(params.channel){var channel=self.channel(params.channel);channel&&channel.handleEvent(params.event,params.data)}internal||self.global_emitter.emit(params.event,params.data)}),this.connection.bind("disconnected",function(){self.channels.disconnect()}),this.connection.bind("error",function(err){Pusher.warn("Error",err)}),Pusher.instances.push(this),this.timeline.info({instances:Pusher.instances.length}),Pusher.isReady&&self.connect()}function checkAppKey(key){(null===key||void 0===key)&&Pusher.warn("Warning","You must pass your app key when you instantiate Pusher.")}var prototype=Pusher.prototype;Pusher.instances=[],Pusher.isReady=!1,Pusher.debug=function(){Pusher.log&&Pusher.log(Pusher.Util.stringify.apply(this,arguments))},Pusher.warn=function(){var message=Pusher.Util.stringify.apply(this,arguments);window.console&&(window.console.warn?window.console.warn(message):window.console.log&&window.console.log(message)),Pusher.log&&Pusher.log(message)},Pusher.ready=function(){Pusher.isReady=!0;for(var i=0,l=Pusher.instances.length;l>i;i++)Pusher.instances[i].connect()},prototype.channel=function(name){return this.channels.find(name)},prototype.allChannels=function(){return this.channels.all()},prototype.connect=function(){if(this.connection.connect(),this.timelineSender&&!this.timelineSenderTimer){var encrypted=this.connection.isEncrypted(),timelineSender=this.timelineSender;this.timelineSenderTimer=new Pusher.PeriodicTimer(6e4,function(){timelineSender.send(encrypted)})}},prototype.disconnect=function(){this.connection.disconnect(),this.timelineSenderTimer&&(this.timelineSenderTimer.ensureAborted(),this.timelineSenderTimer=null)},prototype.bind=function(event_name,callback){return this.global_emitter.bind(event_name,callback),this},prototype.bind_all=function(callback){return this.global_emitter.bind_all(callback),this},prototype.subscribeAll=function(){var channelName;for(channelName in this.channels.channels)this.channels.channels.hasOwnProperty(channelName)&&this.subscribe(channelName)},prototype.subscribe=function(channel_name){var channel=this.channels.add(channel_name,this);return"connected"===this.connection.state&&channel.subscribe(),channel},prototype.unsubscribe=function(channel_name){var channel=this.channels.remove(channel_name);"connected"===this.connection.state&&channel.unsubscribe()},prototype.send_event=function(event_name,data,channel){return this.connection.send_event(event_name,data,channel)},prototype.isEncrypted=function(){return"https:"===Pusher.Util.getDocument().location.protocol?!0:Boolean(this.config.encrypted)},Pusher.HTTP={},this.Pusher=Pusher}.call(this),function(){function clearTimeout(timer){window.clearTimeout(timer)}function clearInterval(timer){window.clearInterval(timer)}function GenericTimer(set,clear,delay,callback){var self=this;this.clear=clear,this.timer=set(function(){null!==self.timer&&(self.timer=callback(self.timer))},delay)}var prototype=GenericTimer.prototype;prototype.isRunning=function(){return null!==this.timer},prototype.ensureAborted=function(){this.timer&&(this.clear(this.timer),this.timer=null)},Pusher.Timer=function(delay,callback){return new GenericTimer(setTimeout,clearTimeout,delay,function(){return callback(),null})},Pusher.PeriodicTimer=function(delay,callback){return new GenericTimer(setInterval,clearInterval,delay,function(timer){return callback(),timer})}}.call(this),function(){Pusher.Util={now:function(){return Date.now?Date.now():(new Date).valueOf()},defer:function(callback){return new Pusher.Timer(0,callback)},extend:function(target){for(var i=1;i<arguments.length;i++){var extensions=arguments[i];for(var property in extensions)target[property]=extensions[property]&&extensions[property].constructor&&extensions[property].constructor===Object?Pusher.Util.extend(target[property]||{},extensions[property]):extensions[property]}return target},stringify:function(){for(var m=["Pusher"],i=0;i<arguments.length;i++)"string"==typeof arguments[i]?m.push(arguments[i]):void 0===window.JSON?m.push(arguments[i].toString()):m.push(JSON.stringify(arguments[i]));return m.join(" : ")},arrayIndexOf:function(array,item){var nativeIndexOf=Array.prototype.indexOf;if(null===array)return-1;if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item);for(var i=0,l=array.length;l>i;i++)if(array[i]===item)return i;return-1},objectApply:function(object,f){for(var key in object)Object.prototype.hasOwnProperty.call(object,key)&&f(object[key],key,object)},keys:function(object){var keys=[];return Pusher.Util.objectApply(object,function(_,key){keys.push(key)}),keys},values:function(object){var values=[];return Pusher.Util.objectApply(object,function(value){values.push(value)}),values},apply:function(array,f,context){for(var i=0;i<array.length;i++)f.call(context||window,array[i],i,array)},map:function(array,f){for(var result=[],i=0;i<array.length;i++)result.push(f(array[i],i,array,result));return result},mapObject:function(object,f){var result={};return Pusher.Util.objectApply(object,function(value,key){result[key]=f(value)}),result},filter:function(array,test){test=test||function(value){return!!value};for(var result=[],i=0;i<array.length;i++)test(array[i],i,array,result)&&result.push(array[i]);return result},filterObject:function(object,test){var result={};return Pusher.Util.objectApply(object,function(value,key){(test&&test(value,key,object,result)||Boolean(value))&&(result[key]=value)}),result},flatten:function(object){var result=[];return Pusher.Util.objectApply(object,function(value,key){result.push([key,value])}),result},any:function(array,test){for(var i=0;i<array.length;i++)if(test(array[i],i,array))return!0;return!1},all:function(array,test){for(var i=0;i<array.length;i++)if(!test(array[i],i,array))return!1;return!0},method:function(name){var boundArguments=Array.prototype.slice.call(arguments,1);return function(object){return object[name].apply(object,boundArguments.concat(arguments))}},getWindow:function(){return window},getDocument:function(){return document},getNavigator:function(){return navigator},getLocalStorage:function(){try{return window.localStorage}catch(e){return void 0}},getClientFeatures:function(){return Pusher.Util.keys(Pusher.Util.filterObject({ws:Pusher.WSTransport,flash:Pusher.FlashTransport},function(t){return t.isSupported({})}))},addWindowListener:function(event,listener){var _window=Pusher.Util.getWindow();void 0!==_window.addEventListener?_window.addEventListener(event,listener,!1):_window.attachEvent("on"+event,listener)},removeWindowListener:function(event,listener){var _window=Pusher.Util.getWindow();void 0!==_window.addEventListener?_window.removeEventListener(event,listener,!1):_window.detachEvent("on"+event,listener)},isXHRSupported:function(){var XHR=window.XMLHttpRequest;return Boolean(XHR)&&void 0!==(new XHR).withCredentials},isXDRSupported:function(encrypted){var protocol=encrypted?"https:":"http:",documentProtocol=Pusher.Util.getDocument().location.protocol;return Boolean(window.XDomainRequest)&&documentProtocol===protocol}}}.call(this),function(){Pusher.VERSION="2.2.4",Pusher.PROTOCOL=7,Pusher.host="ws.pusherapp.com",Pusher.ws_port=80,Pusher.wss_port=443,Pusher.sockjs_host="sockjs.pusher.com",Pusher.sockjs_http_port=80,Pusher.sockjs_https_port=443,Pusher.sockjs_path="/pusher",Pusher.stats_host="stats.pusher.com",Pusher.channel_auth_endpoint="/pusher/auth",Pusher.channel_auth_transport="ajax",Pusher.activity_timeout=12e4,Pusher.pong_timeout=3e4,Pusher.unavailable_timeout=1e4,Pusher.cdn_http="http://js.pusher.com/",Pusher.cdn_https="https://js.pusher.com/",Pusher.dependency_suffix="",Pusher.getDefaultStrategy=function(config){var wsStrategy;return wsStrategy=config.encrypted?[":best_connected_ever",":ws_loop",[":delayed",2e3,[":http_fallback_loop"]]]:[":best_connected_ever",":ws_loop",[":delayed",2e3,[":wss_loop"]],[":delayed",5e3,[":http_fallback_loop"]]],[[":def","ws_options",{hostUnencrypted:config.wsHost+":"+config.wsPort,hostEncrypted:config.wsHost+":"+config.wssPort}],[":def","wss_options",[":extend",":ws_options",{encrypted:!0}]],[":def","sockjs_options",{hostUnencrypted:config.httpHost+":"+config.httpPort,hostEncrypted:config.httpHost+":"+config.httpsPort,httpPath:config.httpPath}],[":def","timeouts",{loop:!0,timeout:15e3,timeoutLimit:6e4}],[":def","ws_manager",[":transport_manager",{lives:2,minPingDelay:1e4,maxPingDelay:config.activity_timeout}]],[":def","streaming_manager",[":transport_manager",{lives:2,minPingDelay:1e4,maxPingDelay:config.activity_timeout}]],[":def_transport","ws","ws",3,":ws_options",":ws_manager"],[":def_transport","wss","ws",3,":wss_options",":ws_manager"],[":def_transport","flash","flash",2,":ws_options",":ws_manager"],[":def_transport","sockjs","sockjs",1,":sockjs_options"],[":def_transport","xhr_streaming","xhr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xdr_streaming","xdr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xhr_polling","xhr_polling",1,":sockjs_options"],[":def_transport","xdr_polling","xdr_polling",1,":sockjs_options"],[":def","ws_loop",[":sequential",":timeouts",":ws"]],[":def","wss_loop",[":sequential",":timeouts",":wss"]],[":def","flash_loop",[":sequential",":timeouts",":flash"]],[":def","sockjs_loop",[":sequential",":timeouts",":sockjs"]],[":def","streaming_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_streaming"],":xhr_streaming",":xdr_streaming"]]],[":def","polling_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_polling"],":xhr_polling",":xdr_polling"]]],[":def","http_loop",[":if",[":is_supported",":streaming_loop"],[":best_connected_ever",":streaming_loop",[":delayed",4e3,[":polling_loop"]]],[":polling_loop"]]],[":def","http_fallback_loop",[":if",[":is_supported",":http_loop"],[":http_loop"],[":sockjs_loop"]]],[":def","strategy",[":cached",18e5,[":first_connected",[":if",[":is_supported",":ws"],wsStrategy,[":if",[":is_supported",":flash"],[":best_connected_ever",":flash_loop",[":delayed",2e3,[":http_fallback_loop"]]],[":http_fallback_loop"]]]]]]]}}.call(this),function(){Pusher.getGlobalConfig=function(){return{wsHost:Pusher.host,wsPort:Pusher.ws_port,wssPort:Pusher.wss_port,httpHost:Pusher.sockjs_host,httpPort:Pusher.sockjs_http_port,httpsPort:Pusher.sockjs_https_port,httpPath:Pusher.sockjs_path,statsHost:Pusher.stats_host,authEndpoint:Pusher.channel_auth_endpoint,authTransport:Pusher.channel_auth_transport,activity_timeout:Pusher.activity_timeout,pong_timeout:Pusher.pong_timeout,unavailable_timeout:Pusher.unavailable_timeout}},Pusher.getClusterConfig=function(clusterName){return{wsHost:"ws-"+clusterName+".pusher.com",httpHost:"sockjs-"+clusterName+".pusher.com"}}}.call(this),function(){function buildExceptionClass(name){var constructor=function(message){Error.call(this,message),this.name=name};return Pusher.Util.extend(constructor.prototype,Error.prototype),constructor}Pusher.Errors={BadEventName:buildExceptionClass("BadEventName"),RequestTimedOut:buildExceptionClass("RequestTimedOut"),TransportPriorityTooLow:buildExceptionClass("TransportPriorityTooLow"),TransportClosed:buildExceptionClass("TransportClosed"),UnsupportedTransport:buildExceptionClass("UnsupportedTransport"),UnsupportedStrategy:buildExceptionClass("UnsupportedStrategy")}}.call(this),function(){function EventsDispatcher(failThrough){this.callbacks=new CallbackRegistry,this.global_callbacks=[],this.failThrough=failThrough}function CallbackRegistry(){this._callbacks={}}function prefix(name){return"_"+name}var prototype=EventsDispatcher.prototype;prototype.bind=function(eventName,callback,context){return this.callbacks.add(eventName,callback,context),this},prototype.bind_all=function(callback){return this.global_callbacks.push(callback),this},prototype.unbind=function(eventName,callback,context){return this.callbacks.remove(eventName,callback,context),this},prototype.unbind_all=function(eventName,callback){return this.callbacks.remove(eventName,callback),this},prototype.emit=function(eventName,data){var i;for(i=0;i<this.global_callbacks.length;i++)this.global_callbacks[i](eventName,data);var callbacks=this.callbacks.get(eventName);if(callbacks&&callbacks.length>0)for(i=0;i<callbacks.length;i++)callbacks[i].fn.call(callbacks[i].context||window,data);else this.failThrough&&this.failThrough(eventName,data);return this},CallbackRegistry.prototype.get=function(name){return this._callbacks[prefix(name)]},CallbackRegistry.prototype.add=function(name,callback,context){var prefixedEventName=prefix(name);this._callbacks[prefixedEventName]=this._callbacks[prefixedEventName]||[],this._callbacks[prefixedEventName].push({fn:callback,context:context})},CallbackRegistry.prototype.remove=function(name,callback,context){if(!name&&!callback&&!context)return this._callbacks={},void 0;var names=name?[prefix(name)]:Pusher.Util.keys(this._callbacks);callback||context?Pusher.Util.apply(names,function(name){this._callbacks[name]=Pusher.Util.filter(this._callbacks[name]||[],function(binding){return callback&&callback!==binding.fn||context&&context!==binding.context}),0===this._callbacks[name].length&&delete this._callbacks[name]},this):Pusher.Util.apply(names,function(name){delete this._callbacks[name]},this)},Pusher.EventsDispatcher=EventsDispatcher}.call(this),function(){function ScriptReceiverFactory(prefix,name){this.lastId=0,this.prefix=prefix,this.name=name}var prototype=ScriptReceiverFactory.prototype;prototype.create=function(callback){this.lastId++;var number=this.lastId,id=this.prefix+number,name=this.name+"["+number+"]",called=!1,callbackWrapper=function(){called||(callback.apply(null,arguments),called=!0)};return this[number]=callbackWrapper,{number:number,id:id,name:name,callback:callbackWrapper}},prototype.remove=function(receiver){delete this[receiver.number]},Pusher.ScriptReceiverFactory=ScriptReceiverFactory,Pusher.ScriptReceivers=new ScriptReceiverFactory("_pusher_script_","Pusher.ScriptReceivers")}.call(this),function(){function ScriptRequest(src){this.src=src}var prototype=ScriptRequest.prototype;prototype.send=function(receiver){var self=this,errorString="Error loading "+self.src;self.script=document.createElement("script"),self.script.id=receiver.id,self.script.src=self.src,self.script.type="text/javascript",self.script.charset="UTF-8",self.script.addEventListener?(self.script.onerror=function(){receiver.callback(errorString)},self.script.onload=function(){receiver.callback(null)}):self.script.onreadystatechange=function(){("loaded"===self.script.readyState||"complete"===self.script.readyState)&&receiver.callback(null)},void 0===self.script.async&&document.attachEvent&&/opera/i.test(navigator.userAgent)?(self.errorScript=document.createElement("script"),self.errorScript.id=receiver.id+"_error",self.errorScript.text=receiver.name+"('"+errorString+"');",self.script.async=self.errorScript.async=!1):self.script.async=!0;var head=document.getElementsByTagName("head")[0];head.insertBefore(self.script,head.firstChild),self.errorScript&&head.insertBefore(self.errorScript,self.script.nextSibling)},prototype.cleanup=function(){this.script&&(this.script.onload=this.script.onerror=null,this.script.onreadystatechange=null),this.script&&this.script.parentNode&&this.script.parentNode.removeChild(this.script),this.errorScript&&this.errorScript.parentNode&&this.errorScript.parentNode.removeChild(this.errorScript),this.script=null,this.errorScript=null},Pusher.ScriptRequest=ScriptRequest}.call(this),function(){function DependencyLoader(options){this.options=options,this.receivers=options.receivers||Pusher.ScriptReceivers,this.loading={}}var prototype=DependencyLoader.prototype;prototype.load=function(name,options,callback){var self=this;if(self.loading[name]&&self.loading[name].length>0)self.loading[name].push(callback);else{self.loading[name]=[callback];var request=new Pusher.ScriptRequest(self.getPath(name,options)),receiver=self.receivers.create(function(error){if(self.receivers.remove(receiver),self.loading[name]){var callbacks=self.loading[name];delete self.loading[name];for(var successCallback=function(wasSuccessful){wasSuccessful||request.cleanup()},i=0;i<callbacks.length;i++)callbacks[i](error,successCallback)}});request.send(receiver)}},prototype.getRoot=function(options){var cdn,protocol=Pusher.Util.getDocument().location.protocol;return cdn=options&&options.encrypted||"https:"===protocol?this.options.cdn_https:this.options.cdn_http,cdn.replace(/\/*$/,"")+"/"+this.options.version},prototype.getPath=function(name,options){return this.getRoot(options)+"/"+name+this.options.suffix+".js"},Pusher.DependencyLoader=DependencyLoader}.call(this),function(){function initialize(){Pusher.ready()}function onDocumentBody(callback){document.body?callback():setTimeout(function(){onDocumentBody(callback)},0)}function initializeOnDocumentBody(){onDocumentBody(initialize)}Pusher.DependenciesReceivers=new Pusher.ScriptReceiverFactory("_pusher_dependencies","Pusher.DependenciesReceivers"),Pusher.Dependencies=new Pusher.DependencyLoader({cdn_http:Pusher.cdn_http,cdn_https:Pusher.cdn_https,version:Pusher.VERSION,suffix:Pusher.dependency_suffix,receivers:Pusher.DependenciesReceivers}),window.JSON?initializeOnDocumentBody():Pusher.Dependencies.load("json2",{},initializeOnDocumentBody)}(),function(){for(var Base64={encode:function(s){return btoa(utob(s))}},fromCharCode=String.fromCharCode,b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64tab={},i=0,l=b64chars.length;l>i;i++)b64tab[b64chars.charAt(i)]=i;var cb_utob=function(c){var cc=c.charCodeAt(0);return 128>cc?c:2048>cc?fromCharCode(192|cc>>>6)+fromCharCode(128|63&cc):fromCharCode(224|cc>>>12&15)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|63&cc)},utob=function(u){return u.replace(/[^\x00-\x7F]/g,cb_utob)},cb_encode=function(ccc){var padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|(ccc.length>1?ccc.charCodeAt(1):0)<<8|(ccc.length>2?ccc.charCodeAt(2):0),chars=[b64chars.charAt(ord>>>18),b64chars.charAt(ord>>>12&63),padlen>=2?"=":b64chars.charAt(ord>>>6&63),padlen>=1?"=":b64chars.charAt(63&ord)];return chars.join("")},btoa=window.btoa||function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode)};Pusher.Base64=Base64}.call(this),function(){function JSONPRequest(url,data){this.url=url,this.data=data}function encodeParamsObject(data){return Pusher.Util.mapObject(data,function(value){return"object"==typeof value&&(value=JSON.stringify(value)),encodeURIComponent(Pusher.Base64.encode(value.toString()))})}var prototype=JSONPRequest.prototype;prototype.send=function(receiver){if(!this.request){var params=Pusher.Util.filterObject(this.data,function(value){return void 0!==value}),query=Pusher.Util.map(Pusher.Util.flatten(encodeParamsObject(params)),Pusher.Util.method("join","=")).join("&"),url=this.url+"/"+receiver.number+"?"+query;this.request=new Pusher.ScriptRequest(url),this.request.send(receiver)}},prototype.cleanup=function(){this.request&&this.request.cleanup()},Pusher.JSONPRequest=JSONPRequest}.call(this),function(){function Timeline(key,session,options){this.key=key,this.session=session,this.events=[],this.options=options||{},this.sent=0,this.uniqueID=0}var prototype=Timeline.prototype;Timeline.ERROR=3,Timeline.INFO=6,Timeline.DEBUG=7,prototype.log=function(level,event){level<=this.options.level&&(this.events.push(Pusher.Util.extend({},event,{timestamp:Pusher.Util.now()})),this.options.limit&&this.events.length>this.options.limit&&this.events.shift())},prototype.error=function(event){this.log(Timeline.ERROR,event)},prototype.info=function(event){this.log(Timeline.INFO,event)},prototype.debug=function(event){this.log(Timeline.DEBUG,event)},prototype.isEmpty=function(){return 0===this.events.length},prototype.send=function(sendJSONP,callback){var self=this,data=Pusher.Util.extend({session:self.session,bundle:self.sent+1,key:self.key,lib:"js",version:self.options.version,cluster:self.options.cluster,features:self.options.features,timeline:self.events},self.options.params);return self.events=[],sendJSONP(data,function(error,result){error||self.sent++,callback&&callback(error,result)}),!0},prototype.generateUniqueID=function(){return this.uniqueID++,this.uniqueID},Pusher.Timeline=Timeline}.call(this),function(){function TimelineSender(timeline,options){this.timeline=timeline,this.options=options||{}}var prototype=TimelineSender.prototype;prototype.send=function(encrypted,callback){var self=this;if(!self.timeline.isEmpty()){var sendJSONP=function(data,callback){var scheme="http"+(encrypted?"s":"")+"://",url=scheme+(self.host||self.options.host)+self.options.path,request=new Pusher.JSONPRequest(url,data),receiver=Pusher.ScriptReceivers.create(function(error,result){Pusher.ScriptReceivers.remove(receiver),request.cleanup(),result&&result.host&&(self.host=result.host),callback&&callback(error,result)});request.send(receiver)};self.timeline.send(sendJSONP,callback)}},Pusher.TimelineSender=TimelineSender}.call(this),function(){function BestConnectedEverStrategy(strategies){this.strategies=strategies}function connect(strategies,minPriority,callbackBuilder){var runners=Pusher.Util.map(strategies,function(strategy,i,_,rs){return strategy.connect(minPriority,callbackBuilder(i,rs))});return{abort:function(){Pusher.Util.apply(runners,abortRunner)},forceMinPriority:function(p){Pusher.Util.apply(runners,function(runner){runner.forceMinPriority(p)})}}}function allRunnersFailed(runners){return Pusher.Util.all(runners,function(runner){return Boolean(runner.error)})}function abortRunner(runner){runner.error||runner.aborted||(runner.abort(),runner.aborted=!0)}var prototype=BestConnectedEverStrategy.prototype;prototype.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))},prototype.connect=function(minPriority,callback){return connect(this.strategies,minPriority,function(i,runners){return function(error,handshake){return runners[i].error=error,error?(allRunnersFailed(runners)&&callback(!0),void 0):(Pusher.Util.apply(runners,function(runner){runner.forceMinPriority(handshake.transport.priority)}),callback(null,handshake),void 0)}})},Pusher.BestConnectedEverStrategy=BestConnectedEverStrategy}.call(this),function(){function CachedStrategy(strategy,transports,options){this.strategy=strategy,this.transports=transports,this.ttl=options.ttl||18e5,this.encrypted=options.encrypted,this.timeline=options.timeline}function getTransportCacheKey(encrypted){return"pusherTransport"+(encrypted?"Encrypted":"Unencrypted")}function fetchTransportCache(encrypted){var storage=Pusher.Util.getLocalStorage();if(storage)try{var serializedCache=storage[getTransportCacheKey(encrypted)];if(serializedCache)return JSON.parse(serializedCache)}catch(e){flushTransportCache(encrypted)}return null}function storeTransportCache(encrypted,transport,latency){var storage=Pusher.Util.getLocalStorage();if(storage)try{storage[getTransportCacheKey(encrypted)]=JSON.stringify({timestamp:Pusher.Util.now(),transport:transport,latency:latency})}catch(e){}}function flushTransportCache(encrypted){var storage=Pusher.Util.getLocalStorage();if(storage)try{delete storage[getTransportCacheKey(encrypted)]}catch(e){}}var prototype=CachedStrategy.prototype;prototype.isSupported=function(){return this.strategy.isSupported()},prototype.connect=function(minPriority,callback){var encrypted=this.encrypted,info=fetchTransportCache(encrypted),strategies=[this.strategy];if(info&&info.timestamp+this.ttl>=Pusher.Util.now()){var transport=this.transports[info.transport];transport&&(this.timeline.info({cached:!0,transport:info.transport,latency:info.latency}),strategies.push(new Pusher.SequentialStrategy([transport],{timeout:2*info.latency+1e3,failFast:!0})))}var startTimestamp=Pusher.Util.now(),runner=strategies.pop().connect(minPriority,function cb(error,handshake){error?(flushTransportCache(encrypted),strategies.length>0?(startTimestamp=Pusher.Util.now(),runner=strategies.pop().connect(minPriority,cb)):callback(error)):(storeTransportCache(encrypted,handshake.transport.name,Pusher.Util.now()-startTimestamp),callback(null,handshake))});return{abort:function(){runner.abort()},forceMinPriority:function(p){minPriority=p,runner&&runner.forceMinPriority(p)}}},Pusher.CachedStrategy=CachedStrategy}.call(this),function(){function DelayedStrategy(strategy,options){this.strategy=strategy,this.options={delay:options.delay}}var prototype=DelayedStrategy.prototype;prototype.isSupported=function(){return this.strategy.isSupported()},prototype.connect=function(minPriority,callback){var runner,strategy=this.strategy,timer=new Pusher.Timer(this.options.delay,function(){runner=strategy.connect(minPriority,callback)});return{abort:function(){timer.ensureAborted(),runner&&runner.abort()},forceMinPriority:function(p){minPriority=p,runner&&runner.forceMinPriority(p)}}},Pusher.DelayedStrategy=DelayedStrategy}.call(this),function(){function FirstConnectedStrategy(strategy){this.strategy=strategy}var prototype=FirstConnectedStrategy.prototype;prototype.isSupported=function(){return this.strategy.isSupported()},prototype.connect=function(minPriority,callback){var runner=this.strategy.connect(minPriority,function(error,handshake){handshake&&runner.abort(),callback(error,handshake)});return runner},Pusher.FirstConnectedStrategy=FirstConnectedStrategy}.call(this),function(){function IfStrategy(test,trueBranch,falseBranch){this.test=test,this.trueBranch=trueBranch,this.falseBranch=falseBranch}var prototype=IfStrategy.prototype;prototype.isSupported=function(){var branch=this.test()?this.trueBranch:this.falseBranch;return branch.isSupported()},prototype.connect=function(minPriority,callback){var branch=this.test()?this.trueBranch:this.falseBranch;return branch.connect(minPriority,callback)},Pusher.IfStrategy=IfStrategy}.call(this),function(){function SequentialStrategy(strategies,options){this.strategies=strategies,this.loop=Boolean(options.loop),this.failFast=Boolean(options.failFast),this.timeout=options.timeout,this.timeoutLimit=options.timeoutLimit}var prototype=SequentialStrategy.prototype;prototype.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))},prototype.connect=function(minPriority,callback){var self=this,strategies=this.strategies,current=0,timeout=this.timeout,runner=null,tryNextStrategy=function(error,handshake){handshake?callback(null,handshake):(current+=1,self.loop&&(current%=strategies.length),current<strategies.length?(timeout&&(timeout=2*timeout,self.timeoutLimit&&(timeout=Math.min(timeout,self.timeoutLimit))),runner=self.tryStrategy(strategies[current],minPriority,{timeout:timeout,failFast:self.failFast},tryNextStrategy)):callback(!0))
};return runner=this.tryStrategy(strategies[current],minPriority,{timeout:timeout,failFast:this.failFast},tryNextStrategy),{abort:function(){runner.abort()},forceMinPriority:function(p){minPriority=p,runner&&runner.forceMinPriority(p)}}},prototype.tryStrategy=function(strategy,minPriority,options,callback){var timer=null,runner=null;return options.timeout>0&&(timer=new Pusher.Timer(options.timeout,function(){runner.abort(),callback(!0)})),runner=strategy.connect(minPriority,function(error,handshake){error&&timer&&timer.isRunning()&&!options.failFast||(timer&&timer.ensureAborted(),callback(error,handshake))}),{abort:function(){timer&&timer.ensureAborted(),runner.abort()},forceMinPriority:function(p){runner.forceMinPriority(p)}}},Pusher.SequentialStrategy=SequentialStrategy}.call(this),function(){function TransportStrategy(name,priority,transport,options){this.name=name,this.priority=priority,this.transport=transport,this.options=options||{}}function failAttempt(error,callback){return Pusher.Util.defer(function(){callback(error)}),{abort:function(){},forceMinPriority:function(){}}}var prototype=TransportStrategy.prototype;prototype.isSupported=function(){return this.transport.isSupported({encrypted:this.options.encrypted})},prototype.connect=function(minPriority,callback){if(!this.isSupported())return failAttempt(new Pusher.Errors.UnsupportedStrategy,callback);if(this.priority<minPriority)return failAttempt(new Pusher.Errors.TransportPriorityTooLow,callback);var self=this,connected=!1,transport=this.transport.createConnection(this.name,this.priority,this.options.key,this.options),handshake=null,onInitialized=function(){transport.unbind("initialized",onInitialized),transport.connect()},onOpen=function(){handshake=new Pusher.Handshake(transport,function(result){connected=!0,unbindListeners(),callback(null,result)})},onError=function(error){unbindListeners(),callback(error)},onClosed=function(){unbindListeners(),callback(new Pusher.Errors.TransportClosed(transport))},unbindListeners=function(){transport.unbind("initialized",onInitialized),transport.unbind("open",onOpen),transport.unbind("error",onError),transport.unbind("closed",onClosed)};return transport.bind("initialized",onInitialized),transport.bind("open",onOpen),transport.bind("error",onError),transport.bind("closed",onClosed),transport.initialize(),{abort:function(){connected||(unbindListeners(),handshake?handshake.close():transport.close())},forceMinPriority:function(p){connected||self.priority<p&&(handshake?handshake.close():transport.close())}}},Pusher.TransportStrategy=TransportStrategy}.call(this),function(){function getGenericURL(baseScheme,params,path){var scheme=baseScheme+(params.encrypted?"s":""),host=params.encrypted?params.hostEncrypted:params.hostUnencrypted;return scheme+"://"+host+path}function getGenericPath(key,queryString){var path="/app/"+key,query="?protocol="+Pusher.PROTOCOL+"&client=js&version="+Pusher.VERSION+(queryString?"&"+queryString:"");return path+query}Pusher.URLSchemes={ws:{getInitial:function(key,params){return getGenericURL("ws",params,getGenericPath(key,"flash=false"))}},flash:{getInitial:function(key,params){return getGenericURL("ws",params,getGenericPath(key,"flash=true"))}},sockjs:{getInitial:function(key,params){return getGenericURL("http",params,params.httpPath||"/pusher","")},getPath:function(key){return getGenericPath(key)}},http:{getInitial:function(key,params){var path=(params.httpPath||"/pusher")+getGenericPath(key);return getGenericURL("http",params,path)}}}}.call(this),function(){function TransportConnection(hooks,name,priority,key,options){Pusher.EventsDispatcher.call(this),this.hooks=hooks,this.name=name,this.priority=priority,this.key=key,this.options=options,this.state="new",this.timeline=options.timeline,this.activityTimeout=options.activityTimeout,this.id=this.timeline.generateUniqueID()}var prototype=TransportConnection.prototype;Pusher.Util.extend(prototype,Pusher.EventsDispatcher.prototype),prototype.handlesActivityChecks=function(){return Boolean(this.hooks.handlesActivityChecks)},prototype.supportsPing=function(){return Boolean(this.hooks.supportsPing)},prototype.initialize=function(){var self=this;self.timeline.info(self.buildTimelineMessage({transport:self.name+(self.options.encrypted?"s":"")})),self.hooks.beforeInitialize&&self.hooks.beforeInitialize.call(self),self.hooks.isInitialized()?self.changeState("initialized"):self.hooks.file?(self.changeState("initializing"),Pusher.Dependencies.load(self.hooks.file,{encrypted:self.options.encrypted},function(error,callback){self.hooks.isInitialized()?(self.changeState("initialized"),callback(!0)):(error&&self.onError(error),self.onClose(),callback(!1))})):self.onClose()},prototype.connect=function(){var self=this;if(self.socket||"initialized"!==self.state)return!1;var url=self.hooks.urls.getInitial(self.key,self.options);try{self.socket=self.hooks.getSocket(url,self.options)}catch(e){return Pusher.Util.defer(function(){self.onError(e),self.changeState("closed")}),!1}return self.bindListeners(),Pusher.debug("Connecting",{transport:self.name,url:url}),self.changeState("connecting"),!0},prototype.close=function(){return this.socket?(this.socket.close(),!0):!1},prototype.send=function(data){var self=this;return"open"===self.state?(Pusher.Util.defer(function(){self.socket&&self.socket.send(data)}),!0):!1},prototype.ping=function(){"open"===this.state&&this.supportsPing()&&this.socket.ping()},prototype.onOpen=function(){this.hooks.beforeOpen&&this.hooks.beforeOpen(this.socket,this.hooks.urls.getPath(this.key,this.options)),this.changeState("open"),this.socket.onopen=void 0},prototype.onError=function(error){this.emit("error",{type:"WebSocketError",error:error}),this.timeline.error(this.buildTimelineMessage({error:error.toString()}))},prototype.onClose=function(closeEvent){closeEvent?this.changeState("closed",{code:closeEvent.code,reason:closeEvent.reason,wasClean:closeEvent.wasClean}):this.changeState("closed"),this.unbindListeners(),this.socket=void 0},prototype.onMessage=function(message){this.emit("message",message)},prototype.onActivity=function(){this.emit("activity")},prototype.bindListeners=function(){var self=this;self.socket.onopen=function(){self.onOpen()},self.socket.onerror=function(error){self.onError(error)},self.socket.onclose=function(closeEvent){self.onClose(closeEvent)},self.socket.onmessage=function(message){self.onMessage(message)},self.supportsPing()&&(self.socket.onactivity=function(){self.onActivity()})},prototype.unbindListeners=function(){this.socket&&(this.socket.onopen=void 0,this.socket.onerror=void 0,this.socket.onclose=void 0,this.socket.onmessage=void 0,this.supportsPing()&&(this.socket.onactivity=void 0))},prototype.changeState=function(state,params){this.state=state,this.timeline.info(this.buildTimelineMessage({state:state,params:params})),this.emit(state,params)},prototype.buildTimelineMessage=function(message){return Pusher.Util.extend({cid:this.id},message)},Pusher.TransportConnection=TransportConnection}.call(this),function(){function Transport(hooks){this.hooks=hooks}var prototype=Transport.prototype;prototype.isSupported=function(environment){return this.hooks.isSupported(environment)},prototype.createConnection=function(name,priority,key,options){return new Pusher.TransportConnection(this.hooks,name,priority,key,options)},Pusher.Transport=Transport}.call(this),function(){Pusher.WSTransport=new Pusher.Transport({urls:Pusher.URLSchemes.ws,handlesActivityChecks:!1,supportsPing:!1,isInitialized:function(){return Boolean(window.WebSocket||window.MozWebSocket)},isSupported:function(){return Boolean(window.WebSocket||window.MozWebSocket)},getSocket:function(url){var Constructor=window.WebSocket||window.MozWebSocket;return new Constructor(url)}}),Pusher.FlashTransport=new Pusher.Transport({file:"flashfallback",urls:Pusher.URLSchemes.flash,handlesActivityChecks:!1,supportsPing:!1,isSupported:function(){try{return Boolean(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(e1){try{var nav=Pusher.Util.getNavigator();return Boolean(nav&&nav.mimeTypes&&void 0!==nav.mimeTypes["application/x-shockwave-flash"])}catch(e2){return!1}}},beforeInitialize:function(){void 0===window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&(window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0),window.WEB_SOCKET_SWF_LOCATION=Pusher.Dependencies.getRoot({encrypted:this.options.encrypted})+"/WebSocketMain.swf"},isInitialized:function(){return void 0!==window.FlashWebSocket},getSocket:function(url){return new FlashWebSocket(url)}}),Pusher.SockJSTransport=new Pusher.Transport({file:"sockjs",urls:Pusher.URLSchemes.sockjs,handlesActivityChecks:!0,supportsPing:!1,isSupported:function(){return!0},isInitialized:function(){return void 0!==window.SockJS},getSocket:function(url,options){return new SockJS(url,null,{js_path:Pusher.Dependencies.getPath("sockjs",{encrypted:options.encrypted}),ignore_null_origin:options.ignoreNullOrigin})},beforeOpen:function(socket,path){socket.send(JSON.stringify({path:path}))}});var httpConfiguration={urls:Pusher.URLSchemes.http,handlesActivityChecks:!1,supportsPing:!0,isInitialized:function(){return Boolean(Pusher.HTTP.Socket)}},streamingConfiguration=Pusher.Util.extend({getSocket:function(url){return Pusher.HTTP.getStreamingSocket(url)}},httpConfiguration),pollingConfiguration=Pusher.Util.extend({getSocket:function(url){return Pusher.HTTP.getPollingSocket(url)}},httpConfiguration),xhrConfiguration={file:"xhr",isSupported:Pusher.Util.isXHRSupported},xdrConfiguration={file:"xdr",isSupported:function(environment){return Pusher.Util.isXDRSupported(environment.encrypted)}};Pusher.XHRStreamingTransport=new Pusher.Transport(Pusher.Util.extend({},streamingConfiguration,xhrConfiguration)),Pusher.XDRStreamingTransport=new Pusher.Transport(Pusher.Util.extend({},streamingConfiguration,xdrConfiguration)),Pusher.XHRPollingTransport=new Pusher.Transport(Pusher.Util.extend({},pollingConfiguration,xhrConfiguration)),Pusher.XDRPollingTransport=new Pusher.Transport(Pusher.Util.extend({},pollingConfiguration,xdrConfiguration))}.call(this),function(){function AssistantToTheTransportManager(manager,transport,options){this.manager=manager,this.transport=transport,this.minPingDelay=options.minPingDelay,this.maxPingDelay=options.maxPingDelay,this.pingDelay=void 0}var prototype=AssistantToTheTransportManager.prototype;prototype.createConnection=function(name,priority,key,options){var self=this;options=Pusher.Util.extend({},options,{activityTimeout:self.pingDelay});var connection=self.transport.createConnection(name,priority,key,options),openTimestamp=null,onOpen=function(){connection.unbind("open",onOpen),connection.bind("closed",onClosed),openTimestamp=Pusher.Util.now()},onClosed=function(closeEvent){if(connection.unbind("closed",onClosed),1002===closeEvent.code||1003===closeEvent.code)self.manager.reportDeath();else if(!closeEvent.wasClean&&openTimestamp){var lifespan=Pusher.Util.now()-openTimestamp;lifespan<2*self.maxPingDelay&&(self.manager.reportDeath(),self.pingDelay=Math.max(lifespan/2,self.minPingDelay))}};return connection.bind("open",onOpen),connection},prototype.isSupported=function(environment){return this.manager.isAlive()&&this.transport.isSupported(environment)},Pusher.AssistantToTheTransportManager=AssistantToTheTransportManager}.call(this),function(){function TransportManager(options){this.options=options||{},this.livesLeft=this.options.lives||1/0}var prototype=TransportManager.prototype;prototype.getAssistant=function(transport){return new Pusher.AssistantToTheTransportManager(this,transport,{minPingDelay:this.options.minPingDelay,maxPingDelay:this.options.maxPingDelay})},prototype.isAlive=function(){return this.livesLeft>0},prototype.reportDeath=function(){this.livesLeft-=1},Pusher.TransportManager=TransportManager}.call(this),function(){function returnWithOriginalContext(f){return function(context){return[f.apply(this,arguments),context]}}function isSymbol(expression){return"string"==typeof expression&&":"===expression.charAt(0)}function getSymbolValue(expression,context){return context[expression.slice(1)]}function evaluateListOfExpressions(expressions,context){if(0===expressions.length)return[[],context];var head=evaluate(expressions[0],context),tail=evaluateListOfExpressions(expressions.slice(1),head[1]);return[[head[0]].concat(tail[0]),tail[1]]}function evaluateString(expression,context){if(!isSymbol(expression))return[expression,context];var value=getSymbolValue(expression,context);if(void 0===value)throw"Undefined symbol "+expression;return[value,context]}function evaluateArray(expression,context){if(isSymbol(expression[0])){var f=getSymbolValue(expression[0],context);if(expression.length>1){if("function"!=typeof f)throw"Calling non-function "+expression[0];var args=[Pusher.Util.extend({},context)].concat(Pusher.Util.map(expression.slice(1),function(arg){return evaluate(arg,Pusher.Util.extend({},context))[0]}));return f.apply(this,args)}return[f,context]}return evaluateListOfExpressions(expression,context)}function evaluate(expression,context){return"string"==typeof expression?evaluateString(expression,context):"object"==typeof expression&&expression instanceof Array&&expression.length>0?evaluateArray(expression,context):[expression,context]}var StrategyBuilder={build:function(scheme,options){var context=Pusher.Util.extend({},globalContext,options);return evaluate(scheme,context)[1].strategy}},transports={ws:Pusher.WSTransport,flash:Pusher.FlashTransport,sockjs:Pusher.SockJSTransport,xhr_streaming:Pusher.XHRStreamingTransport,xdr_streaming:Pusher.XDRStreamingTransport,xhr_polling:Pusher.XHRPollingTransport,xdr_polling:Pusher.XDRPollingTransport},UnsupportedStrategy={isSupported:function(){return!1},connect:function(_,callback){var deferred=Pusher.Util.defer(function(){callback(new Pusher.Errors.UnsupportedStrategy)});return{abort:function(){deferred.ensureAborted()},forceMinPriority:function(){}}}},globalContext={extend:function(context,first,second){return[Pusher.Util.extend({},first,second),context]},def:function(context,name,value){if(void 0!==context[name])throw"Redefining symbol "+name;return context[name]=value,[void 0,context]},def_transport:function(context,name,type,priority,options,manager){var transportClass=transports[type];if(!transportClass)throw new Pusher.Errors.UnsupportedTransport(type);var transport,enabled=!(context.enabledTransports&&-1===Pusher.Util.arrayIndexOf(context.enabledTransports,name)||context.disabledTransports&&-1!==Pusher.Util.arrayIndexOf(context.disabledTransports,name)||"flash"===name&&context.disableFlash===!0);transport=enabled?new Pusher.TransportStrategy(name,priority,manager?manager.getAssistant(transportClass):transportClass,Pusher.Util.extend({key:context.key,encrypted:context.encrypted,timeline:context.timeline,ignoreNullOrigin:context.ignoreNullOrigin},options)):UnsupportedStrategy;var newContext=context.def(context,name,transport)[1];return newContext.transports=context.transports||{},newContext.transports[name]=transport,[void 0,newContext]},transport_manager:returnWithOriginalContext(function(_,options){return new Pusher.TransportManager(options)}),sequential:returnWithOriginalContext(function(_,options){var strategies=Array.prototype.slice.call(arguments,2);return new Pusher.SequentialStrategy(strategies,options)}),cached:returnWithOriginalContext(function(context,ttl,strategy){return new Pusher.CachedStrategy(strategy,context.transports,{ttl:ttl,timeline:context.timeline,encrypted:context.encrypted})}),first_connected:returnWithOriginalContext(function(_,strategy){return new Pusher.FirstConnectedStrategy(strategy)}),best_connected_ever:returnWithOriginalContext(function(){var strategies=Array.prototype.slice.call(arguments,1);return new Pusher.BestConnectedEverStrategy(strategies)}),delayed:returnWithOriginalContext(function(_,delay,strategy){return new Pusher.DelayedStrategy(strategy,{delay:delay})}),"if":returnWithOriginalContext(function(_,test,trueBranch,falseBranch){return new Pusher.IfStrategy(test,trueBranch,falseBranch)}),is_supported:returnWithOriginalContext(function(_,strategy){return function(){return strategy.isSupported()}})};Pusher.StrategyBuilder=StrategyBuilder}.call(this),function(){var Protocol={};Protocol.decodeMessage=function(message){try{var params=JSON.parse(message.data);if("string"==typeof params.data)try{params.data=JSON.parse(params.data)}catch(e){if(!(e instanceof SyntaxError))throw e}return params}catch(e){throw{type:"MessageParseError",error:e,data:message.data}}},Protocol.encodeMessage=function(message){return JSON.stringify(message)},Protocol.processHandshake=function(message){if(message=this.decodeMessage(message),"pusher:connection_established"===message.event){if(!message.data.activity_timeout)throw"No activity timeout specified in handshake";return{action:"connected",id:message.data.socket_id,activityTimeout:1e3*message.data.activity_timeout}}if("pusher:error"===message.event)return{action:this.getCloseAction(message.data),error:this.getCloseError(message.data)};throw"Invalid handshake"},Protocol.getCloseAction=function(closeEvent){return closeEvent.code<4e3?closeEvent.code>=1002&&closeEvent.code<=1004?"backoff":null:4e3===closeEvent.code?"ssl_only":closeEvent.code<4100?"refused":closeEvent.code<4200?"backoff":closeEvent.code<4300?"retry":"refused"},Protocol.getCloseError=function(closeEvent){return 1e3!==closeEvent.code&&1001!==closeEvent.code?{type:"PusherError",data:{code:closeEvent.code,message:closeEvent.reason||closeEvent.message}}:null},Pusher.Protocol=Protocol}.call(this),function(){function Connection(id,transport){Pusher.EventsDispatcher.call(this),this.id=id,this.transport=transport,this.activityTimeout=transport.activityTimeout,this.bindListeners()}var prototype=Connection.prototype;Pusher.Util.extend(prototype,Pusher.EventsDispatcher.prototype),prototype.handlesActivityChecks=function(){return this.transport.handlesActivityChecks()},prototype.send=function(data){return this.transport.send(data)},prototype.send_event=function(name,data,channel){var message={event:name,data:data};return channel&&(message.channel=channel),Pusher.debug("Event sent",message),this.send(Pusher.Protocol.encodeMessage(message))},prototype.ping=function(){this.transport.supportsPing()?this.transport.ping():this.send_event("pusher:ping",{})},prototype.close=function(){this.transport.close()},prototype.bindListeners=function(){var self=this,listeners={message:function(m){var message;try{message=Pusher.Protocol.decodeMessage(m)}catch(e){self.emit("error",{type:"MessageParseError",error:e,data:m.data})}if(void 0!==message){switch(Pusher.debug("Event recd",message),message.event){case"pusher:error":self.emit("error",{type:"PusherError",data:message.data});break;case"pusher:ping":self.emit("ping");break;case"pusher:pong":self.emit("pong")}self.emit("message",message)}},activity:function(){self.emit("activity")},error:function(error){self.emit("error",{type:"WebSocketError",error:error})},closed:function(closeEvent){unbindListeners(),closeEvent&&closeEvent.code&&self.handleCloseEvent(closeEvent),self.transport=null,self.emit("closed")}},unbindListeners=function(){Pusher.Util.objectApply(listeners,function(listener,event){self.transport.unbind(event,listener)})};Pusher.Util.objectApply(listeners,function(listener,event){self.transport.bind(event,listener)})},prototype.handleCloseEvent=function(closeEvent){var action=Pusher.Protocol.getCloseAction(closeEvent),error=Pusher.Protocol.getCloseError(closeEvent);error&&this.emit("error",error),action&&this.emit(action)},Pusher.Connection=Connection}.call(this),function(){function Handshake(transport,callback){this.transport=transport,this.callback=callback,this.bindListeners()}var prototype=Handshake.prototype;prototype.close=function(){this.unbindListeners(),this.transport.close()},prototype.bindListeners=function(){var self=this;self.onMessage=function(m){self.unbindListeners();try{var result=Pusher.Protocol.processHandshake(m);"connected"===result.action?self.finish("connected",{connection:new Pusher.Connection(result.id,self.transport),activityTimeout:result.activityTimeout}):(self.finish(result.action,{error:result.error}),self.transport.close())}catch(e){self.finish("error",{error:e}),self.transport.close()}},self.onClosed=function(closeEvent){self.unbindListeners();var action=Pusher.Protocol.getCloseAction(closeEvent)||"backoff",error=Pusher.Protocol.getCloseError(closeEvent);self.finish(action,{error:error})},self.transport.bind("message",self.onMessage),self.transport.bind("closed",self.onClosed)},prototype.unbindListeners=function(){this.transport.unbind("message",this.onMessage),this.transport.unbind("closed",this.onClosed)},prototype.finish=function(action,params){this.callback(Pusher.Util.extend({transport:this.transport,action:action},params))},Pusher.Handshake=Handshake}.call(this),function(){function ConnectionManager(key,options){Pusher.EventsDispatcher.call(this),this.key=key,this.options=options||{},this.state="initialized",this.connection=null,this.encrypted=!!options.encrypted,this.timeline=this.options.timeline,this.connectionCallbacks=this.buildConnectionCallbacks(),this.errorCallbacks=this.buildErrorCallbacks(),this.handshakeCallbacks=this.buildHandshakeCallbacks(this.errorCallbacks);var self=this;Pusher.Network.bind("online",function(){self.timeline.info({netinfo:"online"}),("connecting"===self.state||"unavailable"===self.state)&&self.retryIn(0)}),Pusher.Network.bind("offline",function(){self.timeline.info({netinfo:"offline"}),self.connection&&self.sendActivityCheck()}),this.updateStrategy()}var prototype=ConnectionManager.prototype;Pusher.Util.extend(prototype,Pusher.EventsDispatcher.prototype),prototype.connect=function(){if(!this.connection&&!this.runner){if(!this.strategy.isSupported())return this.updateState("failed"),void 0;this.updateState("connecting"),this.startConnecting(),this.setUnavailableTimer()}},prototype.send=function(data){return this.connection?this.connection.send(data):!1},prototype.send_event=function(name,data,channel){return this.connection?this.connection.send_event(name,data,channel):!1},prototype.disconnect=function(){this.disconnectInternally(),this.updateState("disconnected")},prototype.isEncrypted=function(){return this.encrypted},prototype.startConnecting=function(){var self=this,callback=function(error,handshake){error?self.runner=self.strategy.connect(0,callback):"error"===handshake.action?(self.emit("error",{type:"HandshakeError",error:handshake.error}),self.timeline.error({handshakeError:handshake.error})):(self.abortConnecting(),self.handshakeCallbacks[handshake.action](handshake))};self.runner=self.strategy.connect(0,callback)},prototype.abortConnecting=function(){this.runner&&(this.runner.abort(),this.runner=null)},prototype.disconnectInternally=function(){if(this.abortConnecting(),this.clearRetryTimer(),this.clearUnavailableTimer(),this.connection){var connection=this.abandonConnection();connection.close()}},prototype.updateStrategy=function(){this.strategy=this.options.getStrategy({key:this.key,timeline:this.timeline,encrypted:this.encrypted})},prototype.retryIn=function(delay){var self=this;self.timeline.info({action:"retry",delay:delay}),delay>0&&self.emit("connecting_in",Math.round(delay/1e3)),self.retryTimer=new Pusher.Timer(delay||0,function(){self.disconnectInternally(),self.connect()})},prototype.clearRetryTimer=function(){this.retryTimer&&(this.retryTimer.ensureAborted(),this.retryTimer=null)},prototype.setUnavailableTimer=function(){var self=this;self.unavailableTimer=new Pusher.Timer(self.options.unavailableTimeout,function(){self.updateState("unavailable")})},prototype.clearUnavailableTimer=function(){this.unavailableTimer&&this.unavailableTimer.ensureAborted()},prototype.sendActivityCheck=function(){var self=this;self.stopActivityCheck(),self.connection.ping(),self.activityTimer=new Pusher.Timer(self.options.pongTimeout,function(){self.timeline.error({pong_timed_out:self.options.pongTimeout}),self.retryIn(0)})},prototype.resetActivityCheck=function(){var self=this;self.stopActivityCheck(),self.connection.handlesActivityChecks()||(self.activityTimer=new Pusher.Timer(self.activityTimeout,function(){self.sendActivityCheck()}))},prototype.stopActivityCheck=function(){this.activityTimer&&this.activityTimer.ensureAborted()},prototype.buildConnectionCallbacks=function(){var self=this;return{message:function(message){self.resetActivityCheck(),self.emit("message",message)},ping:function(){self.send_event("pusher:pong",{})},activity:function(){self.resetActivityCheck()},error:function(error){self.emit("error",{type:"WebSocketError",error:error})},closed:function(){self.abandonConnection(),self.shouldRetry()&&self.retryIn(1e3)}}},prototype.buildHandshakeCallbacks=function(errorCallbacks){var self=this;return Pusher.Util.extend({},errorCallbacks,{connected:function(handshake){self.activityTimeout=Math.min(self.options.activityTimeout,handshake.activityTimeout,handshake.connection.activityTimeout||1/0),self.clearUnavailableTimer(),self.setConnection(handshake.connection),self.socket_id=self.connection.id,self.updateState("connected",{socket_id:self.socket_id})}})},prototype.buildErrorCallbacks=function(){function withErrorEmitted(callback){return function(result){result.error&&self.emit("error",{type:"WebSocketError",error:result.error}),callback(result)}}var self=this;return{ssl_only:withErrorEmitted(function(){self.encrypted=!0,self.updateStrategy(),self.retryIn(0)}),refused:withErrorEmitted(function(){self.disconnect()}),backoff:withErrorEmitted(function(){self.retryIn(1e3)}),retry:withErrorEmitted(function(){self.retryIn(0)})}},prototype.setConnection=function(connection){this.connection=connection;for(var event in this.connectionCallbacks)this.connection.bind(event,this.connectionCallbacks[event]);this.resetActivityCheck()},prototype.abandonConnection=function(){if(this.connection){this.stopActivityCheck();for(var event in this.connectionCallbacks)this.connection.unbind(event,this.connectionCallbacks[event]);var connection=this.connection;return this.connection=null,connection}},prototype.updateState=function(newState,data){var previousState=this.state;this.state=newState,previousState!==newState&&(Pusher.debug("State changed",previousState+" -> "+newState),this.timeline.info({state:newState,params:data}),this.emit("state_change",{previous:previousState,current:newState}),this.emit(newState,data))},prototype.shouldRetry=function(){return"connecting"===this.state||"connected"===this.state},Pusher.ConnectionManager=ConnectionManager}.call(this),function(){function NetInfo(){Pusher.EventsDispatcher.call(this);var self=this;void 0!==window.addEventListener&&(window.addEventListener("online",function(){self.emit("online")},!1),window.addEventListener("offline",function(){self.emit("offline")},!1))}Pusher.Util.extend(NetInfo.prototype,Pusher.EventsDispatcher.prototype);var prototype=NetInfo.prototype;prototype.isOnline=function(){return void 0===window.navigator.onLine?!0:window.navigator.onLine},Pusher.NetInfo=NetInfo,Pusher.Network=new NetInfo}.call(this),function(){function Members(){this.reset()}var prototype=Members.prototype;prototype.get=function(id){return Object.prototype.hasOwnProperty.call(this.members,id)?{id:id,info:this.members[id]}:null},prototype.each=function(callback){var self=this;Pusher.Util.objectApply(self.members,function(member,id){callback(self.get(id))})},prototype.setMyID=function(id){this.myID=id},prototype.onSubscription=function(subscriptionData){this.members=subscriptionData.presence.hash,this.count=subscriptionData.presence.count,this.me=this.get(this.myID)},prototype.addMember=function(memberData){return null===this.get(memberData.user_id)&&this.count++,this.members[memberData.user_id]=memberData.user_info,this.get(memberData.user_id)},prototype.removeMember=function(memberData){var member=this.get(memberData.user_id);return member&&(delete this.members[memberData.user_id],this.count--),member},prototype.reset=function(){this.members={},this.count=0,this.myID=null,this.me=null},Pusher.Members=Members}.call(this),function(){function Channel(name,pusher){Pusher.EventsDispatcher.call(this,function(event){Pusher.debug("No callbacks on "+name+" for "+event)}),this.name=name,this.pusher=pusher,this.subscribed=!1}var prototype=Channel.prototype;Pusher.Util.extend(prototype,Pusher.EventsDispatcher.prototype),prototype.authorize=function(socketId,callback){return callback(!1,{})},prototype.trigger=function(event,data){if(0!==event.indexOf("client-"))throw new Pusher.Errors.BadEventName("Event '"+event+"' does not start with 'client-'");return this.pusher.send_event(event,data,this.name)},prototype.disconnect=function(){this.subscribed=!1},prototype.handleEvent=function(event,data){0===event.indexOf("pusher_internal:")?"pusher_internal:subscription_succeeded"===event&&(this.subscribed=!0,this.emit("pusher:subscription_succeeded",data)):this.emit(event,data)},prototype.subscribe=function(){var self=this;self.authorize(self.pusher.connection.socket_id,function(error,data){error?self.handleEvent("pusher:subscription_error",data):self.pusher.send_event("pusher:subscribe",{auth:data.auth,channel_data:data.channel_data,channel:self.name})})},prototype.unsubscribe=function(){this.pusher.send_event("pusher:unsubscribe",{channel:this.name})},Pusher.Channel=Channel}.call(this),function(){function PrivateChannel(name,pusher){Pusher.Channel.call(this,name,pusher)}var prototype=PrivateChannel.prototype;Pusher.Util.extend(prototype,Pusher.Channel.prototype),prototype.authorize=function(socketId,callback){var authorizer=new Pusher.Channel.Authorizer(this,this.pusher.config);return authorizer.authorize(socketId,callback)},Pusher.PrivateChannel=PrivateChannel}.call(this),function(){function PresenceChannel(name,pusher){Pusher.PrivateChannel.call(this,name,pusher),this.members=new Pusher.Members}var prototype=PresenceChannel.prototype;Pusher.Util.extend(prototype,Pusher.PrivateChannel.prototype),prototype.authorize=function(socketId,callback){var _super=Pusher.PrivateChannel.prototype.authorize,self=this;_super.call(self,socketId,function(error,authData){if(!error){if(void 0===authData.channel_data)return Pusher.warn("Invalid auth response for channel '"+self.name+"', expected 'channel_data' field"),callback("Invalid auth response"),void 0;var channelData=JSON.parse(authData.channel_data);self.members.setMyID(channelData.user_id)}callback(error,authData)})},prototype.handleEvent=function(event,data){switch(event){case"pusher_internal:subscription_succeeded":this.members.onSubscription(data),this.subscribed=!0,this.emit("pusher:subscription_succeeded",this.members);break;case"pusher_internal:member_added":var addedMember=this.members.addMember(data);this.emit("pusher:member_added",addedMember);break;case"pusher_internal:member_removed":var removedMember=this.members.removeMember(data);removedMember&&this.emit("pusher:member_removed",removedMember);break;default:Pusher.PrivateChannel.prototype.handleEvent.call(this,event,data)}},prototype.disconnect=function(){this.members.reset(),Pusher.PrivateChannel.prototype.disconnect.call(this)},Pusher.PresenceChannel=PresenceChannel}.call(this),function(){function Channels(){this.channels={}}function createChannel(name,pusher){return 0===name.indexOf("private-")?new Pusher.PrivateChannel(name,pusher):0===name.indexOf("presence-")?new Pusher.PresenceChannel(name,pusher):new Pusher.Channel(name,pusher)}var prototype=Channels.prototype;prototype.add=function(name,pusher){return this.channels[name]||(this.channels[name]=createChannel(name,pusher)),this.channels[name]},prototype.all=function(){return Pusher.Util.values(this.channels)},prototype.find=function(name){return this.channels[name]},prototype.remove=function(name){var channel=this.channels[name];return delete this.channels[name],channel},prototype.disconnect=function(){Pusher.Util.objectApply(this.channels,function(channel){channel.disconnect()})},Pusher.Channels=Channels}.call(this),function(){Pusher.Channel.Authorizer=function(channel,options){this.channel=channel,this.type=options.authTransport,this.options=options,this.authOptions=(options||{}).auth||{}},Pusher.Channel.Authorizer.prototype={composeQuery:function(socketId){var query="socket_id="+encodeURIComponent(socketId)+"&channel_name="+encodeURIComponent(this.channel.name);for(var i in this.authOptions.params)query+="&"+encodeURIComponent(i)+"="+encodeURIComponent(this.authOptions.params[i]);return query},authorize:function(socketId,callback){return Pusher.authorizers[this.type].call(this,socketId,callback)}};var nextAuthCallbackID=1;Pusher.auth_callbacks={},Pusher.authorizers={ajax:function(socketId,callback){var xhr,self=this;
xhr=Pusher.XHR?new Pusher.XHR:window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),xhr.open("POST",self.options.authEndpoint,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(var headerName in this.authOptions.headers)xhr.setRequestHeader(headerName,this.authOptions.headers[headerName]);return xhr.onreadystatechange=function(){if(4===xhr.readyState)if(200===xhr.status){var data,parsed=!1;try{data=JSON.parse(xhr.responseText),parsed=!0}catch(e){callback(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+xhr.responseText)}parsed&&callback(!1,data)}else Pusher.warn("Couldn't get auth info from your webapp",xhr.status),callback(!0,xhr.status)},xhr.send(this.composeQuery(socketId)),xhr},jsonp:function(socketId,callback){void 0!==this.authOptions.headers&&Pusher.warn("Warn","To send headers with the auth request, you must use AJAX, rather than JSONP.");var callbackName=nextAuthCallbackID.toString();nextAuthCallbackID++;var document=Pusher.Util.getDocument(),script=document.createElement("script");Pusher.auth_callbacks[callbackName]=function(data){callback(!1,data)};var callback_name="Pusher.auth_callbacks['"+callbackName+"']";script.src=this.options.authEndpoint+"?callback="+encodeURIComponent(callback_name)+"&"+this.composeQuery(socketId);var head=document.getElementsByTagName("head")[0]||document.documentElement;head.insertBefore(script,head.firstChild)}}}.call(this);